<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إخباري برو - محرر فيديو إخباري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap">
    <!-- إصدار أحدث وأكثر استقراراً -->
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.15/dist/umd/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #0f0f1a; }
        #sourceDisplay { font-family: 'Amiri', serif; font-weight: 700; }
        #videoPreview {
            width: 720px;
            height: 900px;
            border: 3px solid #a855f7;
            border-radius: 18px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 30px 60px -15px rgba(168, 85, 247, 0.5);
            position: relative;
        }
        #videoElement { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .watermark { position: absolute; bottom: 12px; left: 12px; color: rgba(255,255,255,0.25); font-size: 13px; z-index: 60; pointer-events: none; }
        .progress-bar { position: absolute; bottom: 200px; left: 20px; right: 20px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; z-index: 30; cursor: pointer; }
        .progress-fill { width: 0%; height: 100%; background: linear-gradient(to left, #a855f7, #ec4899); border-radius: 10px; }
        .play-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80px; height: 80px; background: rgba(168, 85, 247, 0.9); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 40px;
            cursor: pointer; z-index: 40; border: 3px solid white; transition: all 0.3s;
        }
        .play-btn:hover { transform: translate(-50%, -50%) scale(1.1); background: #a855f7; }
        .play-btn.hidden { display: none; }
        .loading-spinner {
            border: 5px solid rgba(255,255,255,0.3); border-top-color: #a855f7; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none; }
        .video-controls { position: absolute; bottom: 120px; left: 0; right: 0; display: flex; justify-content: center; gap: 20px; z-index: 30; }
        .control-btn { width: 45px; height: 45px; background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; color: white; font-size: 20px; cursor: pointer; transition: all 0.3s; }
        .control-btn:hover { background: #a855f7; }
        .time-display { color: white; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 30px; font-size: 14px; }
    </style>
</head>
<body class="text-white p-6">

<!-- باقي الـ HTML كما هو (اللوحة اليسرى + المعاينة) ... للاختصار، ضع الـ HTML السابق هنا بدون تغيير كبير -->

<div id="ffmpegLoading" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
    <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-purple-400">جاري تحميل FFmpeg...</p>
    </div>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ 
        log: true,
        // corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js' // اختياري إذا أردت تحديد
    });

    const videoElement = document.getElementById('videoElement');
    // ... باقي المتغيرات كما في الكود السابق (playButton, progressFill, etc.)

    let videoFile = null;
    let ffmpegLoaded = false;

    async function loadFFmpeg() {
        if (ffmpegLoaded) return true;
        document.getElementById('ffmpegLoading').classList.remove('hidden');
        try {
            console.log('جاري تحميل FFmpeg...');
            await ffmpeg.load();
            ffmpegLoaded = true;
            console.log('FFmpeg محمل بنجاح ✓');
        } catch (err) {
            console.error('خطأ تحميل FFmpeg:', err);
            alert('فشل تحميل FFmpeg. تأكد من اتصال إنترنت قوي وحاول مرة أخرى.');
        }
        document.getElementById('ffmpegLoading').classList.add('hidden');
        return ffmpegLoaded;
    }

    // دالة updatePreview و onchange الرفع كما هي سابقاً...

    async function processVideo() {
        if (!videoFile) return alert('ارفع فيديو أولاً!');
        if (!ffmpegLoaded) if (!await loadFFmpeg()) return;

        document.getElementById('processingStatus').classList.remove('hidden');
        document.getElementById('statusText').textContent = 'جاري إضافة النصوص... (قد يأخذ 10-60 ثانية حسب طول الفيديو)';

        try {
            const source = escapeText(document.getElementById('sourceName').value.trim());
            const alertT = escapeText(document.getElementById('alertOrName').value.trim());
            let news   = escapeText(document.getElementById('newsText').value.trim().substring(0,180));
            const dateT = escapeText(document.getElementById('newsDate').value.trim());

            ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(videoFile));

            // خط أساسي + fallback
            let fontUrl = 'https://cdn.jsdelivr.net/npm/@fontsource/amiri/files/amiri-arabic-700-normal.ttf';
            try {
                const resp = await fetch(fontUrl);
                if (!resp.ok) throw new Error('Amiri فشل');
                const buf = await resp.arrayBuffer();
                ffmpeg.FS('writeFile', 'font.ttf', new Uint8Array(buf));
            } catch {
                console.warn('Amiri فشل، جاري تجربة Noto Naskh');
                fontUrl = 'https://cdn.jsdelivr.net/npm/@fontsource/noto-naskh-arabic/files/noto-naskh-arabic-arabic-700-normal.ttf';
                const resp = await fetch(fontUrl);
                const buf = await resp.arrayBuffer();
                ffmpeg.FS('writeFile', 'font.ttf', new Uint8Array(buf));
            }

            const filter = [
                'scale=720:900:force_original_aspect_ratio=decrease,pad=720:900:(ow-iw)/2:(oh-ih)/2:black',
                `drawtext=fontfile=font.ttf:text='${dateT}':fontcolor=white:fontsize=28:x=w-tw-40:y=30:box=1:boxcolor=black@0.4:boxborderw=8`,
                `drawtext=fontfile=font.ttf:text='${alertT}':fontcolor=white:fontsize=48:fontweight=bold:x=w-tw-40:y=180:box=1:boxcolor=red@0.9:boxborderw=12:text_shaping=1`,
                `drawtext=fontfile=font.ttf:text='${news}':fontcolor=white:fontsize=36:x=(w-text_w)/2:y=h/2+80:text_shaping=1:box=1:boxcolor=black@0.5:boxborderw=10`,
                `drawtext=fontfile=font.ttf:text='${source}':fontcolor=white:fontsize=44:fontweight=bold:x=30:y=h-th-40:box=1:boxcolor=black@0.6:boxborderw=10:text_shaping=1`
            ].join(',');

            console.log('جاري تشغيل FFmpeg مع الفلتر...');
            await ffmpeg.run(
                '-i', 'input.mp4',
                '-vf', filter,
                '-c:v', 'libx264', '-preset', 'fast', '-crf', '23',
                '-c:a', 'copy',
                'final.mp4'
            );

            const data = ffmpeg.FS('readFile', 'final.mp4');
            const blob = new Blob([data.buffer], {type: 'video/mp4'});
            videoElement.src = URL.createObjectURL(blob);
            videoFile = new File([blob], 'final_news.mp4', {type: 'video/mp4'});

            document.getElementById('statusText').textContent = 'تم التحرير بنجاح!';
            setTimeout(() => document.getElementById('processingStatus').classList.add('hidden'), 3000);
        } catch (err) {
            console.error('خطأ في processVideo:', err);
            alert('حدث خطأ أثناء التحرير.\nافتح Console (F12) وأخبرني بالرسالة الحمراء التي تظهر.');
        }
    }

    function escapeText(str) {
        return str.replace(/([:'\\])/g, '\\$1').replace(/"/g, '\\"');
    }

    // باقي الدوال (cutVideo, downloadVideo, togglePlay, etc.) تبقى كما هي من الكود السابق

    console.log('الصفحة جاهزة – جرب رفع فيديو قصير (10-20 ثانية) أولاً');
</script>
</body>
</html>
